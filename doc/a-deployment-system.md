# 一个版本发布系统的要素
从开发一个版本发布系统的角度，来看看本系统是如何实现每个环节的。  

## 部署环境
一般来讲，技术部门项目有4种部署环境，开发、测试、预发布、生产，这4种环境，最大的区别就是是否是生产环境。
生产环境的项目发布一定要有严格的权限控制，必须经过运维部门或者主管部门的审核，才可以发布。  
在这里我们在创建部署环境的时候，会要求选择是否是生产环境。  
![](http://7xrmyq.com1.z0.glb.clouddn.com/d1.png)

## 项目管理
在普通的前端项目或者php项目，一个项目就直接部署整个项目的代码，但是在java中，可能是一个项目下面有多个模块，每个模块
作为一个子项目进行部署，类似这种结构：  
![](http://7xrmyq.com1.z0.glb.clouddn.com/d2.png)  
所以为了兼容这种项目，我们在发布系统的项目管理设计上，设计为，一个项目下可以建多个模块，每个模块可以单独进行部署。  
![](http://7xrmyq.com1.z0.glb.clouddn.com/d3.png)  

## 每个模块配置
项目模块的配置是最关键的环节，它的配置关乎到这个项目是从哪里拷贝代码、发布过程通过什么启动、发布到哪一台机器等。  
将以上需求抽象出来，就是分为三个部分，一是基本信息，二是打包-发布过程的执行脚本，三是部署的机器配置。  
我们的实现：  
**基本信息**  
![](http://7xrmyq.com1.z0.glb.clouddn.com/d4.png)  
**脚本配置**   
![](http://7xrmyq.com1.z0.glb.clouddn.com/d5.png)   
**服务器配置**  
![](http://7xrmyq.com1.z0.glb.clouddn.com/d6.png)  
备注：服务器配置上，采用了服务器组和服务器的设计，每次强制限制只能发一个服务器组，好处在于能够强制限制某些核心项目每次只能发几台服务器，避免了出现全部服务器挂掉导致线上服务不可用，做到灰度发布。

## 发起发布请求
发起发布请求，无非就是要确定，哪个项目、发送哪个分支、哪些服务器，在本系统里，还额外处理了，在多台服务器的时候，分批次发布，并且可以配置发布过程的策略，比如发布10台机器，可以配置如果发布过程出现一台异常，那后续的机器将不再发布；也可以配置，即使中间出现发布异常，也继续发布后续机器；这些看业务方自己的选择。  
![](http://7xrmyq.com1.z0.glb.clouddn.com/d7.png)  

## 执行发布
发布过程非常关键，对开发和运维来讲，最重要的信息有这些：  
> 1.发布10台机器，现在进行到哪一台了，整个过程的进度都是清晰的  
> 2.在发布某一台机器的时候，整个项目发布都哪个环节了  
> 3.编译过程是如何的，如果编译失败了，编译失败的具体信息是什么  
> 4.业务系统在某台机器的发布过程，如果失败了，是在stop阶段失败了还是start阶段失败了，进程有没有起来  
> 5.发布过程中，编译环节耗时多少，发完所有的机器耗时多少，整体的机器发布情况，成功多少失败多少  

针对这些，本系统已经实现了  
### 正常情况
![](http://7xrmyq.com1.z0.glb.clouddn.com/d10.png)   
### 异常情况-编译失败
![](http://7xrmyq.com1.z0.glb.clouddn.com/d8.png)   
### 异常情况-服务器权限没开
![](http://7xrmyq.com1.z0.glb.clouddn.com/d9.png)   
